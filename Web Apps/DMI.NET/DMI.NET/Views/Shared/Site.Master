<%@ Master Language="VB" Inherits="System.Web.Mvc.ViewMasterPage" %>
<%@ Import Namespace="DMI.NET" %>

<!DOCTYPE html>
<html>
<head runat="server">
	<title>
		<asp:ContentPlaceHolder ID="TitleContent" runat="server" />
	</title>

	<link rel="Icon" href="~/pictures/logo.ico" type="image/x-icon" />

	<%
		' Mobiles. Fix as tiles display.
		Dim ua As String = Request.UserAgent
		Dim currentLayout As String = "winkit"
		If Not ua = Nothing Then
			If ua.Contains("iPhone") Or ua.Contains("iPad") Or ua.Contains("Android") Then
				currentLayout = "tiles"
				Session("ui-layout-selectable") = "false"
			End If
		End If
		
		Session("CurrentLayout") = DMIEnums.Layout.winkit
		%>


	<%--Here is the stylesheet for the font-icons displayed on the dashboard for wireframe and tile layouts--%>
	<link href="<%= Url.LatestContent("~/Content/font-awesome.min.css")%>" rel="stylesheet" type="text/css" />
	
	<%--Base stylesheets--%>
	<link href="<%: Url.LatestContent("~/Content/Site.css")%>" rel="stylesheet" type="text/css" />
	<link href="<%: Url.LatestContent("~/Content/OpenHR.css")%>" rel="stylesheet" type="text/css" />

	<%--stylesheet for slide-out dmi menu--%>
	<link href="<%: Url.LatestContent("~/Content/contextmenustyle.css")%>" rel="stylesheet" type="text/css" />

	<%--ThemeRoller stylesheet--%>
	<link id="DMIthemeLink" href="<%: Url.LatestContent("~/Content/themes/" & Session("ui-admin-theme").ToString() & "/jquery-ui.min.css")%>" rel="stylesheet" type="text/css" />

	<%--jQuery Grid Stylesheet--%>
	<link href="<%: Url.LatestContent("~/Content/ui.jqgrid.css")%>" rel="stylesheet" type="text/css" />

	<link href="<%: Url.LatestContent("~/Content/table.css")%>" rel="stylesheet" type="text/css" />

	<%--Placeholders for theme and layout--%>
	<link id="layoutLink" href="" rel="stylesheet" type="text/css" />
	<link id="themeLink" href="" rel="stylesheet" type="text/css" />
	<link id="WireframethemeLink" href="" rel="stylesheet" type="text/css" />

	<%--External script resources--%>
	<script src="<%: Url.LatestContent("~/bundles/jQuery")%>" type="text/javascript"></script>
	<script src="<%: Url.LatestContent("~/bundles/jQueryUI7")%>" type="text/javascript"></script>
	<script src="<%: Url.LatestContent("~/bundles/Microsoft")%>" type="text/javascript"></script>
	<script src="<%: Url.LatestContent("~/bundles/OpenHR_General")%>" type="text/javascript"></script>
	<script src="<%: Url.LatestContent("~/bundles/OpenHR_ActiveX")%>" type="text/javascript"></script>	

	<script type="text/javascript">

		window.LocaleDateFormat = "";
		window.SSIMode = '<%=ViewBag.SSIMode%>';
		window.isMobileDevice = '<%=Session("isMobileDevice")%>';

		document.title = 'OpenHR 8.1';
	
		$(document).ready(function () {

			OpenHR.setDatepickerLanguage();

			if (!(window.jQuery.ui)) {
				//no jQuery! so quit out - compatibility mode(?) should be a message on login.aspx...
				return false;
			}

			$("#About").dialog({
				autoOpen: false,
				modal: true,
				width: 500
			});

			$("#errorDialog").dialog({
				autoOpen: false,
				modal: true,			
				width: 650,
				height: 500,
				position: ['center', 100],
			});

			$("#CalendarEvent").dialog({
				autoOpen: false,
				modal: true,
				width: 450,
				height: 323,
				resizable: false
			});

			$("#divthemeRoller").dialog({
				autoOpen: false,
				modal: true,
				width: 350,
				height: 300,
			    resizable: false
			});

			$("#divPollMessage").dialog({
				title: 'OpenHR Web',
				autoOpen: false,
				modal: true,
				width: 350,
				height: 'auto',
				resizable: false,
				dialogClass: 'no-close'
			});
			
			$("#dialog-confirm").dialog({
				autoOpen: false,
				modal: true,
				resizable: false,
				height: 'auto',
				width: 'auto'
			});

			$('#divPopupReportDefinition').dialog({
				autoOpen: false,
				width: 660,
				height: 590,
				resizable: true,
				modal: true
			});

			$(function () {
				$("input[type=submit], input[type=button], button")
					.button();
				$("input").addClass("ui-widget ui-corner-all");
				$("input").removeClass("text");

				$("textarea").addClass("ui-widget ui-corner-tl ui-corner-bl");
				$("textarea").removeClass("text");

				$("select").addClass("ui-widget ui-corner-tl ui-corner-bl");
				$("select").removeClass("text");

				$("input[type=submit], input[type=button], button").removeClass("ui-corner-all");
				$("input[type=submit], input[type=button], button").addClass("ui-corner-tl ui-corner-br");
			});
			
			$("button").css("margin", "5px");			
			if (SSIMode != "True") {
				$("link[id=layoutLink]").attr({ href: "<%:Url.LatestContent("~/Content/DashboardStyles/layouts/winkit.css")%>" });
				$("link[id=themeLink]").attr({ href: "<%:Url.LatestContent("~/Content/DashboardStyles/themes/white.css")%>" });
				$('body').addClass('DMI');
			} else {				
				//only load themes for linksMain.							
				var cookieLayout = getCookie('Intranet_Layout');
				if (cookieLayout === undefined || cookieLayout === "undefined" || cookieLayout.length <= 0) cookieLayout = "winkit";
				if ('<%=currentLayout%>' != 'tiles') {
					if ('<%=UCase(Session("ui-layout-selectable").ToString())%>' == 'TRUE') {
						window.currentLayout = cookieLayout;
					} else {
						window.currentLayout = '<%=Session("ui-self-service-layout")%>';
					}
				}

				<%
		
		' session(currentlayout) is only used in linksMain BTW.
		If currentLayout <> "tiles" Then
			If UCase(Session("ui-layout-selectable")) = "TRUE" Then
				If Request.Cookies("Intranet_Layout") Is Nothing Then
					Session("CurrentLayout") = "winkit"
				Else
					Session("CurrentLayout") = Request.Cookies("Intranet_Layout").Value
				End If
			Else
				Session("CurrentLayout") = Session("ui-self-service-layout")
			End If
		Else
			' Mobile only.
			Session("CurrentLayout") = "tiles"
		End If
		
		%>

				var cookiewireframeTheme = getCookie("Intranet_Wireframe_Theme");
				if (cookiewireframeTheme === undefined || cookiewireframeTheme === "undefined" || cookiewireframeTheme.length <= 0) cookiewireframeTheme = '<%=Session("ui-wireframe-theme").ToString()%>';
				if ('<%=UCase(Session("ui-layout-selectable").ToString())%>' == 'TRUE') {
					cookiewireframeTheme = cookiewireframeTheme;
				} else {					
					cookiewireframeTheme = '<%=Session("ui-wireframe-theme")%>';					
				}

				//cookieapplyWireframeTheme is for upgraded systems, who want to use the old custom_config.txt values.
				window.cookieapplyWireframeTheme = getCookie("Apply_Wireframe_Theme");
				if (cookieapplyWireframeTheme === undefined || cookieapplyWireframeTheme === "undefined" || cookieapplyWireframeTheme.length <= 0) {
					window.cookieapplyWireframeTheme = "false";
				}

				$('body').addClass('SSI');
				//Kill themeRoller:
				if (($("#fixedlinksframe").length > 0) && (window.currentLayout != "winkit"))
					$("link[id=DMIthemeLink]").attr({ href: "" });

				switch (window.currentLayout) {
				case "winkit":
					$("link[id=layoutLink]").attr({ href: "<%:Url.LatestContent("~/Content/DashboardStyles/layouts/winkit.css")%>" });
					$("link[id=SSIthemeLink]").attr({ href: "<%:Url.LatestContent("~/Content/themes/" & Session("ui-winkit-theme").ToString() & "/jquery-ui.min.css")%>" });
					$("link[id=DMIthemeLink]").attr({ href: "<%:Url.LatestContent("~/Content/themes/" & Session("ui-winkit-theme").ToString() & "/jquery-ui.min.css")%>" });
					break;
				case "wireframe":
					if (cookieapplyWireframeTheme == "true") $("link[id=WireframethemeLink]").attr({ href: "../Content/DashboardStyles/themes/upgraded.css" });

					$("link[id=layoutLink]").attr({ href: "<%:Url.LatestContent("~/Content/DashboardStyles/layouts/wireframe.css")%>" });
					$("link[id=SSIthemeLink]").attr({ href: "../Content/themes/" + cookiewireframeTheme + "/jquery-ui.min.css" });
					$("link[id=DMIthemeLink]").attr({ href: "../Content/themes/" + cookiewireframeTheme + "/jquery-ui.min.css" });
					break;
				case "tiles":
					$("link[id=layoutLink]").attr({ href: "<%:Url.LatestContent("~/Content/DashboardStyles/layouts/tiles.css")%>" });
					$("link[id=SSIthemeLink]").attr({ href: "<%:Url.LatestContent("~/Content/themes/" & Session("ui-tiles-theme").ToString() & "/jquery-ui.min.css")%>" });
					$("link[id=DMIthemeLink]").attr({ href: "<%:Url.LatestContent("~/Content/themes/" & Session("ui-tiles-theme").ToString() & "/jquery-ui.min.css")%>" });
					break;
				}			

			}
			//Save some cookies we will need in other parts of the system
			setCookie("SSIMode", SSIMode, 100);
			if ('<%=UCase(Session("ui-layout-selectable").ToString())%>' == 'TRUE') {
				setCookie("currentLayout", "<%=currentLayout%>", 100);
				setCookie("cookiewireframeTheme", cookiewireframeTheme, 100);
				setCookie("cookieapplyWireframeTheme", window.cookieapplyWireframeTheme, 100);
			}
			//Apply ajax Loading message
			$(document).ajaxStart(function () {
				setTimeout('updateProgressMsg()', 50);
				$("body").addClass("loading");
			});

			$(document).ajaxStop(function () {
				$('#txtProgressMessage').val('Loading...');
				$("body").removeClass("loading");
				setTimeout('updateProgressMsg()', 50);
			});

		});
		
		function updateProgressMsg() {
			$('.progressMessage span').text($('#txtProgressMessage').val());
		}
		
	</script>

	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<script type="text/javascript">		
		//if ((screen.width < 768) || (screen.height < 748)) {			
		//	viewport = document.querySelector("meta[name=viewport]");
		//	viewport.setAttribute('content', 'width=460;');
		//	window.isMobileBrowser = true;		
		//}
		//else {
		//	window.isMobileBrowser = false;
		//}

		//Reset the session timeout everytime the user clicks the mouse
		$(window).on('click', function() {
			if ($('#frmLoginForm').length == 0) { //Don't reset the timeout if we are in the Login screen
				resetTimeout();
			}
		});
		
		function resetTimeout() {			
			window.clearTimeout(window.timeoutHandle);
			window.timeoutHandle = window.setTimeout('OpenHR.SessionTimeout(1);', (Number('<%=Session("TimeoutSecs")%>') * 1000));
			window.onbeforeunload = null;
		}

		function getCookie(cName) {
			var i, x, y, arrCookies = document.cookie.split(";");
			for (i = 0; i < arrCookies.length; i++) {
				x = arrCookies[i].substr(0, arrCookies[i].indexOf("="));
				y = arrCookies[i].substr(arrCookies[i].indexOf("=") + 1);
				x = x.replace(/^\s+|\s+$/g, "");
				if (x == cName) {
					if (y === undefined || y === "undefined" || y.length <= 0) y = "";
					return unescape(y);
				}
			}
			return '';
		}

		function setCookie(cName, value, exdays) {
			var exdate = new Date();
			exdate.setDate(exdate.getDate() + exdays);
			var cValue = escape(value) + ((exdays == null) ? "" : "; expires=" + exdate.toUTCString());
			document.cookie = cName + "=" + cValue;
		}

		window.currentLayout = "<%=currentLayout %>";

		//set up ROOT variable for use in external JS files.
		window.ROOT = '<%= Url.Content("~/") %>';

		var language = window.navigator.userLanguage || window.navigator.language;
		
		//Set locale-related global variables
		window.UserLocale = language;
		window.LocaleThousandSeparator = "<%=LocaleThousandSeparator%>";
		window.LocaleDecimalSeparator = "<%=LocaleDecimalSeparator%>";


		function loadPartialView(action, controller, targetDiv, params) {
			$.ajax({
				url: window.ROOT + controller + "/" + action,
				data: { psScreenInfo: params },
				dataType: 'html',
				type: "POST",
				success: function (html) {
					try {						
						if ((action.toUpperCase() != "POLL") && (action.toUpperCase() != "REFRESH") && (action.toUpperCase() != "THEMEEDITOR")) {
							if (action.toUpperCase().substr(0, 9) == "LINKSMAIN") {
								//$('#' + targetDiv).fadeOut('slow');
								$('.DashContent').show();								
							} else {
								$('.DashContent').fadeOut('slow');
								$('#' + targetDiv).show();
							}

							$("#" + targetDiv).html('');
							$("#" + targetDiv).html(html);

							//jQuery styling...

							$(function () {
								$("input[type=submit], input[type=button], button")
									.button();
								$("input").addClass("ui-widget ui-corner-all");
								$("input").removeClass("text");

								$("textarea").addClass("ui-widget ui-corner-tl ui-corner-bl");
								$("textarea").removeClass("text");

								$("select").addClass("ui-widget ui-corner-tl ui-corner-bl");
								$("select").removeClass("text");
								$("input[type=submit], input[type=button], button").removeClass("ui-corner-all");
								$("input[type=submit], input[type=button], button").addClass("ui-corner-tl ui-corner-br");
							});
						} else {
							$("#" + targetDiv).html('');
							$("#" + targetDiv).html(html);
						}

						if (action.toUpperCase().substr(0, 9) == "LINKSMAIN") {

							resizeDashboard();

						}
					} catch (e) {
						$("#errorDialogTitle").text(e.toString);
						$("#errorDialogContentText").html(e.responseText);
						$("#errorDialog").dialog("open");
					}
				},
				error: function (req, status, errorObj) {
					//TODO: remove this popup. Used for debugging only.
					$("#errorDialogTitle").text(errorObj);
					$("#errorDialogContentText").html(req.responseText);
					$("#errorDialog").dialog("open");
				}
			});
		}

		function resizeDashboard() {

			//Resize the dashboard - ensure width is sufficient
			if (window.currentLayout == 'tiles') {				
				var pwfswidth = 0;
				var hlwidth = 0;
				var buttonwidth = 0;
				var dropdownlinkswidth = 0;
				
				if ($('.pendingworkflowsframe').length > 0) pwfswidth = Number($('.pendingworkflowsframe').css('width').replace('px', ''));
				if ($('.hypertextlinks').length > 0) hlwidth = Number(document.querySelector('.hypertextlinks').offsetWidth);
				if ($('.linkspagebutton').length > 0) buttonwidth = Number($('.linkspagebutton').css('width').replace('px', ''));
				if ($('.dropdownlinks').length > 0) dropdownlinkswidth = Number($('.dropdownlinks').css('width').replace('px', ''));
				var requiredWidth = pwfswidth + hlwidth + buttonwidth + dropdownlinkswidth + 300 + 300;
				if(requiredWidth > 0)
				{
					requiredWidth += 'px';
					$('.tileContent').css('width', requiredWidth);
				}
				
				//reset search box...
				$('#searchDashboardString').val('');

			} else {
				var width = 0;
				$('.ButtonLinkColumn ').each(function () {
					width += $(this).outerWidth(true);
				});
				$('.linkspagebuttonbox').css('width', width + 50);

			}
		}


	</script>


</head>
<body class="ui-widget absolutefull">

	<div id="banner" class="header-banner" style="background-color: <%=Session("Config-banner-colour")%>"><%Html.RenderPartial("~/views/shared/_banner.ascx")%></div>

	<header class="ui-widget ui-widget-header">
		<asp:ContentPlaceHolder runat="server" ID="FixedLinksContent"></asp:ContentPlaceHolder>
	</header>
	<asp:ContentPlaceHolder ID="MainContent" runat="server"></asp:ContentPlaceHolder>
	<div class="modal">
		<!-- AJAX please wait spinner -->
		<div class="divProgressMessage">			
			<p class="progressMessage"><span class="ui-state-highlight ui-corner-all">Loading...</span></p>
		</div>
	</div>

	<div id="About" title="About OpenHR" style="display: none;"><%Html.RenderPartial("~/views/account/about.ascx")%></div>

	<div id="errorDialog" title="AJAX call failed">
		<div id="errorDialogTitleContent">
			<h1 id="errorDialogTitle"></h1>
		</div>
		<div id="errorDialogContent">
			<p id="errorDialogContentText"></p>
		</div>
	</div>
	
	<div id="CalendarEvent"></div>
	<div id="divPopupReportDefinition" />

	<div id="dialog-confirm" title="">
		<p><span class="ui-icon ui-icon-help" style="float: left; margin: 0 7px 20px 0;"></span></p>
	</div>

	<div id="divthemeRoller" title=""></div>
	
	<div id="divPollMessage" style="display: block;">
		<form id="frmPollMessage" action="pollMessage" />		
	</div>


	<iframe name="submit-iframe" style="display: none;"></iframe>

	<%--<div id="footer-banner" class="footer-banner ui-widget ui-state-default">
		<p id="footerbannerprogress" class="footer-banner-p-progress" runat="server"></p>
		<p class="footer-banner-p-copyright"><a href="http://www.advancedcomputersoftware.com" target="_blank">Copyright © Advanced Business Software and Solutions Ltd</a></p>
	</div>--%>
</body>
</html>
